<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAN Game Vote</title>
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <header class="text-center mb-12">
            <div class="flex justify-between items-center mb-4">
                <div></div> <!-- Spacer -->
                <div>
                    <h1 class="text-4xl font-bold text-indigo-700 mb-2">LAN Game Vote</h1>
                    <p class="text-gray-600 max-w-2xl mx-auto">Vote for the games you'd like to play at the LAN party! Select "Interested" for games you want to play, "Maybe" for games you're open to, or "Not Interested" for games you'd rather avoid.</p>
                    <p class="text-gray-600 max-w-2xl mx-auto">Make sure to click "Submit" at the bottom to save your votes!</p>
                </div>
                <button id="themeToggle" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 transition">
                    <svg id="sunIcon" class="w-6 h-6 text-yellow-500 hidden" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd" />
                    </svg>
                    <svg id="moonIcon" class="w-6 h-6 text-gray-800 dark:text-gray-200" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" />
                    </svg>
                </button>
            </div>
        </header>

        <div id="notification" class="hidden fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg">
            Vote submitted successfully!
        </div>

        <form id="voteForm" class="w-full">
            <div class="mb-8 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <div class="form-group">
                    <label for="userName" class="form-label">Your Name <span class="text-red-500">*</span></label>
                    <select id="userName" name="userName" required class="form-input">
                        <option value="" disabled selected>Select your name</option>
                        <option value="f4d3r">f4d3r</option>
                        <option value="FalconHoof">FalconHoof</option>
                        <option value="gFiddle">gFiddle</option>
                        <option value="GermZ">GermZ</option>
                        <option value="GrandMarshalCuboit">GrandMarshalCuboit</option>
                        <option value="hatuey">hatuey</option>
                        <option value="nasdaq_">nasdaq_</option>
                        <option value="ProfessorJ">ProfessorJ</option>
                        <option value="Qwibz">Qwibz</option>
                        <option value="Ripcity">Ripcity</option>
                        <option value="TheGreatVirus">TheGreatVirus</option>
                        <option value="tricklestein">tricklestein</option>
                        <option value="WeAKsIDe">WeAKsIDe</option>
                    </select>
                </div>
            </div>
            
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Vote for Games</h2>
                <div class="mb-6">
                    <input type="text" id="gameSearch" placeholder="Search games by title..." class="w-full md:w-1/2 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-indigo-400">
                </div>
                <p class="text-gray-600 mb-6">Select your interest level for each game:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="gamesGrid">
                {% for game in games %}
                <div class="game-card bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100">
                    <div class="card-content p-5">
                        <div>
                            <h3 class="game-title">
                                <a href="{{ game.url }}" target="_blank" class="text-indigo-600 hover:underline hover:text-blue-800 transition-colors">
                                    {{ game.title }}
                                </a>
                            </h3>
                            <p class="game-meta">
                                {{ game.price }} â€¢ {{ game.max_players }} players
                            </p>
                            
                            <!-- Game Media -->
                            <div class="video-container aspect-ratio-box relative group">
                                {% if game.steam_app_id or game.youtube_id %}
                                    <div class="video-thumbnail-container w-full h-full relative">
                                        <div class="w-full h-full bg-gray-900 flex items-center justify-center">
                                            {% if game.steam_app_id %}
                                                <img 
                                                    src="https://steamcdn-a.akamaihd.net/steam/apps/{{ game.steam_app_id }}/header.jpg" 
                                                    alt="{{ game.title }} thumbnail"
                                                    class="video-thumbnail w-full h-full object-cover opacity-90 hover:opacity-100 transition-opacity duration-200"
                                                    data-fallback-youtube="{{ game.youtube_id or '' }}"
                                                    data-game-title="{{ game.title }}"
                                                    loading="lazy"
                                                >
                                            {% elif game.youtube_id %}
                                                <img 
                                                    src="https://img.youtube.com/vi/{{ game.youtube_id }}/hqdefault.jpg" 
                                                    alt="{{ game.title }} thumbnail"
                                                    class="video-thumbnail w-full h-full object-cover opacity-90 hover:opacity-100 transition-opacity duration-200"
                                                    data-game-title="{{ game.title }}"
                                                    loading="lazy"
                                                >
                                            {% endif %}
                                        </div>
                                        <div 
                                            class="play-thumbnail absolute inset-0 flex items-center justify-center cursor-pointer bg-black bg-opacity-20 hover:bg-opacity-30 transition-all duration-200"
                                            data-video-id="{{ game.youtube_id or '' }}"
                                            data-steam-app-id="{{ game.steam_app_id or '' }}"
                                            data-game-title="{{ game.title }}"
                                        >
                                            <div class="play-icon bg-black bg-opacity-70 hover:bg-red-600 w-16 h-16 rounded-full flex items-center justify-center transition-all duration-200 transform hover:scale-110 group">
                                                <svg class="w-8 h-8 text-white group-hover:scale-110 transition-transform" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M8 5v14l11-7z"></path>
                                                </svg>
                                            </div>
                                            <span class="sr-only">Play {{ game.title }} trailer</span>
                                        </div>
                                    </div>
                                {% elif 'steam' in game.url %}
                                    <!-- Steam Game Cover with Play Button -->
                                    {% set app_id = game.url.split('/app/')[1].split('/')[0] %}
                                    <div class="aspect-ratio-box relative group">
                                        <img 
                                            src="https://steamcdn-a.akamaihd.net/steam/apps/{{ app_id }}/header.jpg" 
                                            alt="{{ game.title }} thumbnail" 
                                            class="w-full h-full object-cover"
                                            onerror="this.onerror=null; this.src='https://via.placeholder.com/600x300/1a202c/ffffff?text=No+Image'; this.className='w-full h-full object-contain p-4 bg-gray-100'"
                                        >
                                        <div 
                                            class="play-thumbnail absolute inset-0 flex items-center justify-center cursor-pointer bg-black bg-opacity-30 hover:bg-opacity-40 transition-all duration-200"
                                            data-steam-app-id="{{ app_id }}"
                                            {% if game.youtube_id %}
                                                data-video-id="{{ game.youtube_id }}"
                                            {% endif %}
                                        >
                                            <div class="play-icon bg-black bg-opacity-70 hover:bg-red-600 w-16 h-16 rounded-full flex items-center justify-center transition-all duration-200 transform hover:scale-110">
                                                <svg class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M8 5v14l11-7z"></path>
                                                </svg>
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                    <!-- Fallback for games without video -->
                                    <div class="no-video-placeholder">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z" />
                                        </svg>
                                        <p class="text-sm text-gray-600">{{ game.title }}</p>
                                        <a href="{{ game.url }}" target="_blank" class="text-indigo-600 hover:underline text-sm mt-1 inline-block">View on Store</a>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Voting Options -->
                        <div class="vote-options">
                            <label class="vote-option" data-vote="interested">
                                <input type="radio" name="{{ game.id }}" value="interested">
                                <span>Interested</span>
                            </label>
                            <label class="vote-option" data-vote="maybe">
                                <input type="radio" name="{{ game.id }}" value="maybe">
                                <span>Maybe</span>
                            </label>
                            <label class="vote-option" data-vote="not-interested">
                                <input type="radio" name="{{ game.id }}" value="not-interested">
                                <span>Not Interested</span>
                            </label>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="mt-12 text-center">
                <button type="submit" class="submit-btn">
                    Submit Your Votes
                </button>
                <div>
                    <a href="/results" class="results-link">
                        View Current Results
                    </a>
                </div>
            </div>
        </form>

        <!-- Add Game Form -->
        <div class="mt-16 bg-white p-8 rounded-xl shadow-sm border border-gray-100">
            <details class="group">
                <summary class="cursor-pointer text-xl font-bold text-gray-800 group-open:mb-4">
                    Suggest a New Game
                </summary>
                <p class="text-gray-600 mb-6">Know a great LAN game not on the list? Add it here! All fields except Title and URL are optional.</p>
                <form id="addGameForm" action="/add_game" method="post" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="gameTitle" class="form-label">Game Title <span class="text-red-500">*</span></label>
                            <input type="text" id="gameTitle" name="title" required class="form-input" maxlength="100">
                        </div>
                        <div>
                            <label for="gameUrl" class="form-label">Store URL <span class="text-red-500">*</span></label>
                            <input type="url" id="gameUrl" name="url" required class="form-input" maxlength="500" placeholder="https://store.steampowered.com/app/...">
                        </div>
                        <div>
                            <label for="gamePrice" class="form-label">Price</label>
                            <input type="text" id="gamePrice" name="price" class="form-input" maxlength="50" placeholder="e.g., $19.99 or FREE">
                        </div>
                        <div>
                            <label for="gamePlayers" class="form-label">Max Players</label>
                            <input type="text" id="gamePlayers" name="max_players" class="form-input" maxlength="50" placeholder="e.g., 8">
                        </div>
                        <div class="md:col-span-2">
                            <label for="gameYoutube" class="form-label">YouTube Trailer ID (optional)</label>
                            <input type="text" id="gameYoutube" name="youtube_id" class="form-input" maxlength="20" placeholder="e.g., dQw4w9WgXcQ">
                        </div>
                    </div>
                    <div class="text-center">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300">
                            Add Game
                        </button>
                    </div>
                </form>
            </details>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // Show success/error messages from query params
        const urlParams = new URLSearchParams(window.location.search);
        const success = urlParams.get('success');
        const error = urlParams.get('error');
        if (success) {
            const notification = document.getElementById('notification');
            notification.textContent = success;
            notification.classList.remove('hidden', 'bg-red-500');
            notification.classList.add('bg-green-500');
            setTimeout(() => notification.classList.add('hidden'), 5000);
        } else if (error) {
            const notification = document.getElementById('notification');
            notification.textContent = error;
            notification.classList.remove('hidden', 'bg-green-500');
            notification.classList.add('bg-red-500');
            setTimeout(() => notification.classList.add('hidden'), 5000);
        }

        // Dark Mode Toggle
        const themeToggle = document.getElementById('themeToggle');
        const sunIcon = document.getElementById('sunIcon');
        const moonIcon = document.getElementById('moonIcon');
        const body = document.body;

        // Check for saved theme preference or default to light
        const currentTheme = localStorage.getItem('theme') || 'light';
        if (currentTheme === 'dark') {
            body.classList.add('dark');
            sunIcon.classList.remove('hidden');
            moonIcon.classList.add('hidden');
        }

        themeToggle.addEventListener('click', () => {
            body.classList.toggle('dark');
            const isDark = body.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            sunIcon.classList.toggle('hidden', !isDark);
            moonIcon.classList.toggle('hidden', isDark);
        });

        // Game Search/Filter
        const gameSearch = document.getElementById('gameSearch');
        const gamesGrid = document.getElementById('gamesGrid');
        const gameCards = gamesGrid.querySelectorAll('.game-card');

        gameSearch.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            gameCards.forEach(card => {
                const title = card.querySelector('.game-title a').textContent.toLowerCase();
                if (title.includes(query)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        });

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/js/sw.js')
                .then(reg => console.log('SW registered'))
                .catch(err => console.log('SW registration failed'));
        }

        // Add Game Form Validation
        const addGameForm = document.getElementById('addGameForm');
        addGameForm.addEventListener('submit', (e) => {
            const title = document.getElementById('gameTitle').value.trim();
            const url = document.getElementById('gameUrl').value.trim();
            if (!title || !url) {
                e.preventDefault();
                alert('Title and URL are required.');
                return;
            }
            if (title.length > 100) {
                e.preventDefault();
                alert('Title must be 100 characters or less.');
                return;
            }
            if (url.length > 500) {
                e.preventDefault();
                alert('URL must be 500 characters or less.');
                return;
            }
            // Basic URL validation
            try {
                new URL(url);
            } catch {
                e.preventDefault();
                alert('Please enter a valid URL.');
                return;
            }
        });
    </script>
